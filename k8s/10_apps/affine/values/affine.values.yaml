# Redis Configuration (for bitnami/redis chart)
auth:
  enabled: false
architecture: standalone

version: &version 0.26.2 

# Affine Configuration (for bjw-s/app-template chart)
controllers:
  main:
    replicas: 1
    initContainers:
      init-db:
        image:
          repository: ghcr.io/home-operations/postgres-init
          tag: 18
        env:
          INIT_POSTGRES_SUPER_PASS:
            valueFrom:
              secretKeyRef:
                name: postgres-superuser
                key: password
          INIT_POSTGRES_HOST: postgres-rw.cloudnative-pg.svc.cluster.local
          INIT_POSTGRES_DBNAME: affine
          INIT_POSTGRES_USER: affine
          INIT_POSTGRES_PASS:
            valueFrom:
              secretKeyRef:
                name: affine-db-secret
                key: password
      init-migration:
        image:
          repository: ghcr.io/toeverything/affine
          tag: *version
        command: ['sh', '-c', 'npm run predeploy']
        env:
          NODE_ENV: production
          # DATABASE_URL constructed with secret
          DATABASE_URL: "postgres://affine:$(AFFINE_DB_PASSWORD)@postgres-rw.cloudnative-pg.svc.cluster.local:5432/affine"
          REDIS_SERVER_HOST: affine-redis
          REDIS_SERVER_PORT: 6379
          AFFINE_INDEXER_ENABLED: false
          AFFINE_DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: affine-db-secret
                key: password
      init-permissions:
        image:
          repository: ghcr.io/toeverything/affine
          tag: *version
        command: ["sh", "-c", "chown -R 1000:1000 /data/config /data/storage /mnt/src"]
        securityContext:
          runAsUser: 0
    pod:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
    containers:
      main:
        image:
          repository: ghcr.io/toeverything/affine
          tag: *version
        env:
          NODE_ENV: production
          AFFINE_SERVER_HOST: 0.0.0.0
          AFFINE_SERVER_PORT: 3010
          # DATABASE_URL constructed with secret
          DATABASE_URL: "postgres://affine:$(AFFINE_DB_PASSWORD)@postgres-rw.cloudnative-pg.svc.cluster.local:5432/affine"
          AFFINE_DB_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: affine-db-secret
                key: password
          REDIS_SERVER_HOST: affine-redis
          REDIS_SERVER_PORT: 6379
          CONFIG_LOCATION: /data/config
          UPLOAD_LOCATION: /data/storage
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            memory: 1Gi

persistence:
  config:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce
    advancedMounts:
      main:
        main:
          - path: /data/config
        init-permissions:
          - path: /data/config
  
  storage:
    enabled: true
    size: 10Gi
    accessMode: ReadWriteOnce
    advancedMounts:
      main:
        main:
          - path: /data/storage
        init-permissions:
          - path: /data/storage

  src-overlay:
    enabled: true
    type: emptyDir
    advancedMounts:
      main:
        main:
          - path: /app/src
        init-permissions:
          - path: /mnt/src

service:
  main:
    controller: main
    ports:
      http:
        port: 3010

rawResources:
  middleware:
    enabled: true
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    nameOverride: default-headers
    spec:
      spec:
        headers:
          browserXssFilter: true
          contentTypeNosniff: true
          forceSTSHeader: true
          stsIncludeSubdomains: true
          stsPreload: true
          stsSeconds: 15552000
          referrerPolicy: no-referrer
          contentSecurityPolicy: "default-src 'none'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' https: data:; connect-src 'self' https:; frame-src 'self' https:; media-src 'self' https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';"
          customFrameOptionsValue: SAMEORIGIN
          customRequestHeaders:
            X-Forwarded-Proto: https
  ingress-route:
    enabled: true
    apiVersion: traefik.io/v1alpha1
    kind: IngressRoute
    annotations:
      external-dns.alpha.kubernetes.io/target: 192.168.1.200
      kubernetes.io/ingress.class: traefik-external
    spec:
      spec:
        entryPoints:
          - websecure
        routes:
          - match: Host(`affine.local.naguiar.dev`) || Host(`affine.naguiar.dev`)
            kind: Rule
            middlewares:
              - name: affine-default-headers
            services:
              - name: affine
                port: 3010
        tls:
          secretName: affine-tls
