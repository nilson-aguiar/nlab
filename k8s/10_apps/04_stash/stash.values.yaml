controllers:
  stash:
#    initContainers:
#      repair-db:
#        securityContext:
#          runAsNonRoot: false
#          runAsUser: 568
#          runAsGroup: 568
#          fsGroup: 568
#          allowPrivilegeEscalation: false
##        entrypoint: [ "until </tmp/done; do sleep 1; done" ]
#        command: [ "/config/repair.sh" ]
#        image:
#          repository: keinos/sqlite3
#          tag: 3.50.4
    containers:
      app:
        image:
          repository: stashapp/stash
          tag: v0.28.1
        env:
          TZ: Europe/Amsterdam
          STASH_CACHE: /config/cache
          STASH_GENERATED: /config/generated
          STASH_METADATA: /config/metadata
          USER: 568
          STASH_PORT: 9999
          STASH_STASH: /data
          STASH_CONFIG_FILE: /config/config.yml
        ports:
          - name: http
            containerPort: &stashPort 9999
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568
    fsGroupChangePolicy: OnRootMismatch
    supplementalGroups: [44, 10000]
    seccompProfile: { type: RuntimeDefault }
service:
  app:
    controller: stash
    ports:
      http:
        port: *stashPort

persistence:
  config:
    existingClaim: stash-config
#    size: 2Gi
#    storageClass: longhorn
#    retain: true
#    accessMode: ReadWriteOnce
    globalMounts:
      - path: "/config"
  tmp:
    type: emptyDir
  media:
    size: 1Ti
    storageClass: secondary
    retain: true
    accessMode: ReadWriteMany
    globalMounts:
      - path: /data
        subPath: media
        readOnly: false

starHostSuffix: &starHostSuffix "*.local.naguiar.dev"
hostSuffix: &hostSuffix "local.naguiar.dev"

rawResources:
  middleware:
    enabled: true
    apiVersion: traefik.io/v1alpha1
    kind: Middleware
    nameOverride: default-headers
    spec:
      spec:
        headers:
          browserXssFilter: true
          contentTypeNosniff: true
          forceSTSHeader: true
          stsIncludeSubdomains: true
          stsPreload: true
          stsSeconds: 15552000
          referrerPolicy: no-referrer
          contentSecurityPolicy: "default-src 'none'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https: data:; connect-src 'self' https:; frame-src 'self' https:; media-src 'self' https:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';"
          customFrameOptionsValue: SAMEORIGIN
          customRequestHeaders:
            X-Forwarded-Proto: https
  ingress-route:
    enabled: true
    apiVersion: traefik.io/v1alpha1
    kind: IngressRoute
    annotations:
      external-dns.alpha.kubernetes.io/target: 192.168.1.200
      kubernetes.io/ingress.class: traefik-external
    spec:
      spec:
        entryPoints:
          - websecure
        routes:
          - match: Host(`stash.local.naguiar.dev`)
            kind: Rule
            middlewares:
              - name: stash-default-headers
            services:
              - name: stash
                port: *stashPort
        tls:
          secretName: certificate-tls
